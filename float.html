<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        body {
            background-color: rgba(0, 0, 0, 0);
        }
        .ball {
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-family: sans-serif;
            font-size: 40vh;
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s ease-in-out;
        }
        .ball.dragging {
            transform: scale(0.9);
            background-color: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body>
    <div class="ball" id="floatingBall">
        抽选
    </div>
    <script>
        const ball = document.getElementById('floatingBall');
        let isMouseDown = false;
        let isDragging = false;
        let startTime = 0;
        let startPos = { x: 0, y: 0 };
        let lastPos = { x: 0, y: 0 };

        const startAction = (event) => {
            isMouseDown = true;
            isDragging = false;
            ball.classList.remove('dragging');
            startTime = Date.now();
            const currentX = event.screenX || event.touches[0].screenX;
            const currentY = event.screenY || event.touches[0].screenY;
            startPos = { x: currentX, y: currentY };
            lastPos = { x: currentX, y: currentY };
            window.addEventListener('mousemove', moveAction);
            window.addEventListener('touchmove', moveAction);
            window.addEventListener('mouseup', endAction);
            window.addEventListener('touchend', endAction);
        };

        const moveAction = (event) => {
            if (!isMouseDown) return;
            const currentX = event.screenX || event.touches[0].screenX;
            const currentY = event.screenY || event.touches[0].screenY;
            const deltaX = currentX - lastPos.x;
            const deltaY = currentY - lastPos.y;
            const displacement = Math.sqrt(
                Math.pow(currentX - startPos.x, 2) + Math.pow(currentY - startPos.y, 2)
            );
            if (displacement > 4 && !isDragging) {
                isDragging = true;
                ball.classList.add('dragging');
            }

            if (isDragging && window.electronAPI) {
                window.electronAPI.moveWindow({ deltaX, deltaY });
            }

            lastPos = { x: currentX, y: currentY };
        };

        const endAction = (event) => {
            if (!isMouseDown) return;
            const elapsedTime = Date.now() - startTime;
            const finalX = event.screenX || event.changedTouches[0].screenX;
            const finalY = event.screenY || event.changedTouches[0].screenY;
            const displacement = Math.sqrt(
                Math.pow(finalX - startPos.x, 2) + Math.pow(finalY - startPos.y, 2)
            );
            if (elapsedTime < 200 && displacement <= 4) {
                 if (window.electronAPI) {
                    window.electronAPI.handleFloatBallClick();
                 }
            }
            isMouseDown = false;
            isDragging = false;
            ball.classList.remove('dragging');
            window.removeEventListener('mousemove', moveAction);
            window.removeEventListener('touchmove', moveAction);
            window.removeEventListener('mouseup', endAction);
            window.removeEventListener('touchend', endAction);
        };

        ball.addEventListener('mousedown', startAction);
        ball.addEventListener('touchstart', startAction);

        function updateStyle(settings) {
            const { color, opacity, text, fontSize } = settings.floatBall;
            const ball = document.getElementById('floatingBall');
            
            function hexToRgba(hex, alpha) {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }

            if (settings.floatBall.backgroundType === 'image') {
                ball.style.backgroundImage = `url('icon.png')`;
                ball.style.backgroundSize = 'contain';
                ball.style.backgroundRepeat = 'no-repeat';
                ball.style.backgroundPosition = 'center';
                ball.textContent = text;
                ball.style.fontSize = `${fontSize}vh`;
            } else {
                ball.style.backgroundColor = hexToRgba(color, opacity);
                ball.textContent = text;
                ball.style.fontSize = `${fontSize}vh`;
                ball.style.backgroundImage = 'none';
            }
        }

        window.addEventListener('DOMContentLoaded', async () => {
            if (window.electronAPI) {
                const settings = await window.electronAPI.getSettings();
                if (settings) updateStyle(settings);
            }
        });
    </script>
</body>
</html>